// ==UserScript==
// @name         ToodleChute
// @namespace    https://github.com/nettabo/toodlechute
// @description  Toodledoでタスクシュートしたくなるツール
// @author       nettabo
// @version      0.2.0
// @include      http://www.toodledo.com/tasks/index.php*
// @include      https://www.toodledo.com/tasks/index.php*
// ==/UserScript==
(function(e,c){var b=e.getElementsByTagName("head")[0];var a=e.createElement("script");a.setAttribute("src","http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js");a.addEventListener("load",function(){var d=e.createElement("script");d.textContent="jQuery.noConflict();("+c.toString()+")(jQuery);";b.appendChild(d)},false);b.appendChild(a)})(document,function(c){var b=function(){var k=c("#head").width();var l=c('<style type="text/css">#tc-wrapper {position: relative; top: 0px; left: 0px; width: '+k+'px; height: 35px; margin-top: 1px; margin-bottom: 1px;} #tc-hoge {display: -webkit-box; display: -moz-box; position: relative; top: 0px; left: 0px; width: 100%; height: 21px; background-color: #D8D8D1; margin-top: 1px; margin-bottom: 1px; border-bottom: 1px solid #999; text-align: center; font-size: 12px;} #tc-sec-a {-webkit-box-flex: 1; -moz-box-flex: 1; background: transparent; -webkit-box-ordinal-group: 1; -moz-box-ordinal-group: 1; border-right: 1px solid #FFF; padding-top: 5px;} #tc-sec-b {-webkit-box-flex: 1; -moz-box-flex: 1; background: transparent; -webkit-box-ordinal-group: 2; -moz-box-ordinal-group: 2; border-right: 1px solid #FFF; padding-top: 5px;} #tc-sec-c {-webkit-box-flex: 1; -moz-box-flex: 1; background: transparent; -webkit-box-ordinal-group: 3; -moz-box-ordinal-group: 3; border-right: 1px solid #FFF; padding-top: 5px;} #tc-sec-d {-webkit-box-flex: 1; -moz-box-flex: 1; background: transparent; -webkit-box-ordinal-group: 4; -moz-box-ordinal-group: 4; border-right: 1px solid #FFF; padding-top: 5px;} #tc-sec-e {-webkit-box-flex: 1; -moz-box-flex: 1; background: transparent; -webkit-box-ordinal-group: 5; -moz-box-ordinal-group: 5; border-right: 1px solid #FFF; padding-top: 5px;} #tc-sec-f {-webkit-box-flex: 1; -moz-box-flex: 1; background: transparent; -webkit-box-ordinal-group: 6; -moz-box-ordinal-group: 6; border-right: 1px solid #FFF; padding-top: 5px;} #tc-sec-g {-webkit-box-flex: 1; -moz-box-flex: 1; background: transparent; -webkit-box-ordinal-group: 7; -moz-box-ordinal-group: 7; border-right: 1px solid #FFF; padding-top: 5px;} #tc-sec-h {-webkit-box-flex: 1; -moz-box-flex: 1; background: transparent; -webkit-box-ordinal-group: 8; -moz-box-ordinal-group: 8; border-right: 1px solid #FFF; padding-top: 5px;} #tc-sec-i {-webkit-box-flex: 1; -moz-box-flex: 1; background: transparent; -webkit-box-ordinal-group: 9; -moz-box-ordinal-group: 9; border-right: 1px solid #FFF; padding-top: 5px;} #tc-sec-j {-webkit-box-flex: 1; -moz-box-flex: 1; background: transparent; -webkit-box-ordinal-group: 10; -moz-box-ordinal-group: 10; border-right: 1px solid #FFF; padding-top: 5px;} #tc-sec-k {-webkit-box-flex: 1; -moz-box-flex: 1; background: transparent; -webkit-box-ordinal-group: 11; -moz-box-ordinal-group: 11; border-right: 1px solid #FFF; padding-top: 5px;} #tc-sec-l {-webkit-box-flex: 1; -moz-box-flex: 1; background: transparent; -webkit-box-ordinal-group: 12; -moz-box-ordinal-group: 12; padding-top: 5px;} #tc-buri {position: relative; top: 0px; left: 0px; width: 100%; height: 12px; background-color: #eeeeee; margin-bottom: 1px;} #tc-bar-a {position: absolute; z-index: 0; top: 0px; left: 0px; width: 0%; height: 12px; font-size: 10px;} #tc-bar-b {position: absolute; z-index: 0; top: 0px; left: 0px; width: 0%; height: 12px; font-size: 10px;} #tc-bar-c {position: absolute; z-index: 0; top: 0px; left: 0px; width: 0%; height: 12px; font-size: 10px;} #tc-bar-d {position: absolute; z-index: 0; top: 0px; left: 0px; width: 0%; height: 12px; font-size: 10px;} #tc-bar-e {position: absolute; z-index: 0; top: 0px; left: 0px; width: 0%; height: 12px; font-size: 10px;} #tc-bar-f {position: absolute; z-index: 0; top: 0px; left: 0px; width: 0%; height: 12px; font-size: 10px;} #tc-bar-g {position: absolute; z-index: 0; top: 0px; left: 0px; width: 0%; height: 12px; font-size: 10px;} #tc-bar-h {position: absolute; z-index: 0; top: 0px; left: 0px; width: 0%; height: 12px; font-size: 10px;} #tc-bar-i {position: absolute; z-index: 0; top: 0px; left: 0px; width: 0%; height: 12px; font-size: 10px;} #tc-bar-j {position: absolute; z-index: 0; top: 0px; left: 0px; width: 0%; height: 12px; font-size: 10px;} #tc-bar-k {position: absolute; z-index: 0; top: 0px; left: 0px; width: 0%; height: 12px; font-size: 10px;} #tc-bar-l {position: absolute; z-index: 0; top: 0px; left: 0px; width: 0%; height: 12px; font-size: 10px;} #tc-bar-now {position: absolute; z-index: 1; top: 0px; left: 0px; width: 0px; height: 12px; font-size: 10px; background-color: #eeeeee; color: #000000; text-align: right;} #tc-bar-end {position: absolute; z-index: 1; top: 0px; left: 0px; width: 0px; height: 12px; font-size: 10px; background-color: #eeeeee; color: #000000; text-align: left;} #tc-setting {position: absolute; z-index: 999; top: 100px; left: 100px; width: 320px; height: 90px; border: solid 1px #666; background-color: #fff; padding: 20px; border-radius: 8px; -webkit-border-radius: 8px; -moz-border-radius: 8px; box-shadow: 1px 1px 2px 0px #666; -webkit-box-shadow: 1px 1px 2px 0px #666; -moz-box-shadow: 1px 1px 2px 0px #666;} .tc-balloon div:before {content: ""; position: absolute; bottom: 130px; left: 128px; width: 0px; height: 0px; border-width: 9px 9px 9px 9px; border-style: solid; border-color: transparent transparent #666 transparent} .tc-balloon div:after {content: ""; position: absolute; bottom: 129px; left: 128px; width: 0px; height: 0px; border-width: 9px 9px 9px 9px; border-style: solid; border-color: transparent transparent #fff transparent} .tc-clearfix {display: block; margin-bottom: 18px;} .tc-clearfix > label {width: 80px; float: left; text-align: right; color: #404040;} .tc-input {margin-left: 100px;} .tc-help-block {display: block; color: #bfbfbf; font-size: 12px;} </style>');l.appendTo("body")};var e=function(){var k=c('<div id="tc-wrapper"></div>').hide();var l=c('<div id="tc-hoge"></div>');k.append(l);l.append('<div id="tc-sec-a">A=0:00</div>');l.append('<div id="tc-sec-b">B=0:00</div>');l.append('<div id="tc-sec-c">C=0:00</div>');l.append('<div id="tc-sec-d">D=0:00</div>');l.append('<div id="tc-sec-e">E=0:00</div>');l.append('<div id="tc-sec-f">F=0:00</div>');l.append('<div id="tc-sec-g">G=0:00</div>');l.append('<div id="tc-sec-h">H=0:00</div>');l.append('<div id="tc-sec-i">I=0:00</div>');l.append('<div id="tc-sec-j">J=0:00</div>');l.append('<div id="tc-sec-k">K=0:00</div>');l.append('<div id="tc-sec-l">L=0:00</div>');var m=c('<div id="tc-buri"></div>');l.after(m);m.append('<div id="tc-bar-now"></div>');m.append('<div id="tc-bar-a"></div>');m.append('<div id="tc-bar-b"></div>');m.append('<div id="tc-bar-c"></div>');m.append('<div id="tc-bar-d"></div>');m.append('<div id="tc-bar-e"></div>');m.append('<div id="tc-bar-f"></div>');m.append('<div id="tc-bar-g"></div>');m.append('<div id="tc-bar-h"></div>');m.append('<div id="tc-bar-i"></div>');m.append('<div id="tc-bar-j"></div>');m.append('<div id="tc-bar-k"></div>');m.append('<div id="tc-bar-l"></div>');m.append('<div id="tc-bar-end"></div>');c("#colhead").before(k);return k};function j(){var k=false;if(c("#vb8").hasClass("selected")){k=true}else{if(c("#vb4").hasClass("selected")&&c(".tabon").text().match(/(Today|Tomorrow)/)){k=true}}return k}function a(){if(!j()){f.hide();window.setTimeout(function(){a()},1000);return}var u=parseInt(localStorage.tc_start_time,10);var s=parseInt(localStorage.tc_sec_length,10);var v={A:0,B:0,C:0,D:0,E:0,F:0,G:0,H:0,I:0,J:0,K:0,L:0};c(".row").each(function(){var E=c(this).find("span[id^=con]").text().toUpperCase();if(E.match(/^([A-L])/)){var H=RegExp.$1;if(s==3){c("#tc-sec-h").css("border-right","none");c("#tc-sec-i").hide();c("#tc-sec-j").hide();c("#tc-sec-k").hide();c("#tc-sec-l").hide()}else{c("#tc-sec-h").css("border-right","1px solid #FFF");c("#tc-sec-i").show();c("#tc-sec-j").show();c("#tc-sec-k").show();c("#tc-sec-l").show()}var G=c(this).find("span[class=len]").text().split(" ");if(G.length>1){var F=G[0];var I=G[1];if(I.match(/^hour/)){F=F*60}if(!c(this).hasClass("rowcomp")){v[H]=parseInt(v[H],10)+parseInt(F,10)}}}});var m=new Date();var B=m.getMonth()+1;var D=m.getDate();var p=("0"+m.getHours()).slice(-2);var C=("0"+m.getMinutes()).slice(-2);var y=("0"+m.getSeconds()).slice(-2);var t=c("#tc-wrapper").width();var l=false;var z=0;if(parseInt(p,10)<parseInt(u,10)){z=(t*(((24+parseInt(p,10)-u)*60)+parseInt(C,10)))/(24*60);m.setDate(D-1);B=m.getMonth()+1;D=m.getDate();l=true}else{z=(t*(((p-u)*60)+parseInt(C,10)))/(24*60)}Math.round(z);var x=c(".tabon").text();var w=x.match(/[0-9]+/g);var k=false;if(c("#tabs").text().match(/(Today|今日)/i)){if(!l&&(x.match(/Today/i)||x.match("今日"))){k=true}else{if(l&&(x.match(/Yesterday/i)||x.match("昨日"))){k=true}}}else{if(w){if(w.length==2){if((parseInt(w[0],10)==parseInt(B,10))&&(parseInt(w[1],10)==parseInt(D,10))){k=true}}else{if(parseInt(w[0],10)==parseInt(D,10)){k=true}}}}if(k){c("#tc-bar-now").text(p+":"+C).width(z).css("border-right","1px solid #000")}else{c("#tc-bar-now").text("").width(0).css("border-right","none")}var r=c("#tc-bar-now").width()+1;var A=0;c.each(v,function(H,J){var F=parseInt(J/60,10);var G=("0"+(J-(F*60))).slice(-2);c("#tc-sec-"+H.toLowerCase()).text(H+"="+F+":"+G);if(J>0){var I=Math.round((t*J)/(24*60));var K;var E=s*60;if(J>E){K="#ee99bc"}else{if(J>(E*0.9)){K="#ffd900"}else{K="#a7be53"}}c("#tc-bar-"+H.toLowerCase()).css("left",r).width(I).css("background-color",K);r+=I+1;A+=J}else{c("#tc-bar-"+H.toLowerCase()).width(0)}});var o;if(k){o=m}else{o=new Date();o.setHours(u);o.setMinutes(0)}o.setMinutes(o.getMinutes()+A);var n=("0"+o.getHours()).slice(-2);var q=("0"+o.getMinutes()).slice(-2);c("#tc-bar-end").css("left",r).text(n+":"+q);if(j()){f.show()}else{f.hide()}window.setTimeout(function(){a()},1000)}var g=function(){c("#proflinks").prepend('<a id="tc-setting-link" href="#">ToodleChute</a>&nbsp;|&nbsp;')};var h=function(){c("body").append('<div id="tc-setting" class="tc-balloon" style="display: none;"><div class="tc-clearfix"><label for="tc-start-time">開始時刻</label><div class="tc-input"><select id="tc-start-time" name="start-time"><option value="0">00:00</option><option value="1">01:00</option><option value="2">02:00</option><option value="3">03:00</option><option value="4">04:00</option><option value="5">05:00</option><option value="6">06:00</option><option value="7">07:00</option><option value="8">08:00</option><option value="9">09:00</option><option value="10">10:00</option><option value="11">11:00</option><option value="12">12:00</option><option value="13">13:00</option><option value="14">14:00</option><option value="15">15:00</option><option value="16">16:00</option><option value="17">17:00</option><option value="18">18:00</option><option value="19">19:00</option><option value="20">20:00</option><option value="21">21:00</option><option value="22">22:00</option><option value="23">23:00</option></select><span class="tc-help-block">1日の開始時刻</span></div></div><div class="tc-clearfix"><label for="tc-sec-length">セクション長</label><div class="tc-input"><input type="radio" id="tc-sec-length-2h" name="sec-length" value="2" /><label for="tc-sec-length-2h">&nbsp;2時間&nbsp;&nbsp;</label><input type="radio" id="tc-sec-length-3h" name="sec-length" value="3" /><label for="tc-sec-length-3h">&nbsp;3時間</label><span class="tc-help-block">1セクションあたりの長さ</span></div></div></div>')};var i=function(){localStorage.tc_start_time=localStorage.tc_start_time?localStorage.tc_start_time:6;localStorage.tc_sec_length=localStorage.tc_sec_length?localStorage.tc_sec_length:3};g();h();i();var d=false;c("#tc-setting-link").click(function(){if(d){c("#tc-setting").hide();d=false}else{c("#tc-start-time").val(localStorage.tc_start_time);var k=localStorage.tc_sec_length;c("input[id^=tc-sec-length]").removeAttr("checked");c("#tc-sec-length-"+k+"h").attr("checked","checked");var l=c("#tc-setting-link").offset();c("#tc-setting").css("top",l.top+20).css("left",l.left-100);c("#tc-setting").show();d=true}return false});c("body").click(function(n){if(d){var m=c("#tc-setting");var l=m.offset();var k=m.width()+parseInt(m.css("padding-left"),10)+parseInt(m.css("padding-right"),10);var o=m.height()+parseInt(m.css("padding-top"),10)+parseInt(m.css("padding-bottom"),10);if(!((l.left<=n.pageX)&&(n.pageX<=(l.left+k))&&(l.top<=n.pageY)&&(n.pageY<=(l.top+o)))){m.hide();d=false}}});c("#tc-start-time").change(function(){localStorage.tc_start_time=c(this).val()});c("input[id^=tc-sec-length]").change(function(){localStorage.tc_sec_length=c(this).val()});b();var f=e();a()});